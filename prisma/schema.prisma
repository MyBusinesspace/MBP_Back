generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String   @unique
  name      String?
  surname   String?
  avatar    String?
  googleId  String   @unique @map("google_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  companyUsers       CompanyUser[]
  teamUsers          TeamUser[]
  createdInvitations Invitation[]      @relation("CreatedInvitations")
  invitationUses     InvitationUse[]
  taskAssignments    TaskAssignment[]

  @@map("users")
}

model Company {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  address   String?
  phone     String?
  email     String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  companyUsers      CompanyUser[]
  contacts          Contact[]        @relation("CompanyContacts")
  contactReferences Contact[]        @relation("ContactCompany")
  teams             Team[]
  teamUsers         TeamUser[]
  projects          Project[]
  invitations       Invitation[]
  workingOrders     WorkingOrder[]
  taskCategories    TaskCategory[]
  taskDetails       TaskDetail[]
  tasks             Task[]

  @@map("companies")
}

model CompanyUser {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  teamUsers TeamUser[]

  @@unique([userId, companyId], name: "company_users_unique")
  @@map("company_users")
}

model Contact {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId        String   @map("company_id") @db.Uuid
  contactCompanyId String?  @map("contact_company_id") @db.Uuid
  contactName      String   @map("contact_name")
  isActiveContact  Boolean  @default(true) @map("is_active_contact")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  company        Company        @relation("CompanyContacts", fields: [companyId], references: [id], onDelete: Cascade)
  contactCompany Company?       @relation("ContactCompany", fields: [contactCompanyId], references: [id], onDelete: SetNull)
  projects       Project[]
  workingOrders  WorkingOrder[]
  taskDetails    TaskDetail[]
  tasks          Task[]

  @@map("contacts")
}

model Team {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  name      String
  code      String
  color     String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  teamUsers       TeamUser[]
  taskAssignments TaskAssignment[]

  @@map("teams")
}

model TeamUser {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  teamId    String   @map("team_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  team        Team        @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyUser CompanyUser @relation(fields: [userId, companyId], references: [userId, companyId], onDelete: Cascade)

  @@unique([companyId, userId], name: "team_users_one_team_per_company")
  @@map("team_users")
}

model Project {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  contactId   String   @map("contact_id") @db.Uuid
  name        String
  description String?
  status      String
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact       Contact        @relation(fields: [contactId], references: [id], onDelete: Restrict)
  workingOrders WorkingOrder[]
  taskDetails   TaskDetail[]
  tasks         Task[]

  @@map("projects")
}

model Invitation {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId       String    @map("company_id") @db.Uuid
  createdByUserId String    @map("created_by_user_id") @db.Uuid
  code            String    @unique @db.VarChar(32)
  maxUses         Int?      @map("max_uses")
  currentUses     Int       @default(0) @map("current_uses")
  expiresAt       DateTime? @map("expires_at") @db.Timestamptz(6)
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy      User            @relation("CreatedInvitations", fields: [createdByUserId], references: [id], onDelete: Cascade)
  invitationUses InvitationUse[]

  @@index([companyId], name: "idx_invitations_company_id")
  @@index([code], name: "idx_invitations_code")
  @@index([createdByUserId], name: "idx_invitations_created_by")
  @@index([isActive, expiresAt], name: "idx_invitations_active")
  @@map("invitations")
}

model InvitationUse {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invitationId String   @map("invitation_id") @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  usedAt       DateTime @default(now()) @map("used_at") @db.Timestamptz(6)
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  userAgent    String?  @map("user_agent")

  invitation Invitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([invitationId], name: "idx_invitation_uses_invitation_id")
  @@index([userId], name: "idx_invitation_uses_user_id")
  @@map("invitation_uses")
}

model WorkingOrder {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  contactId String   @map("contact_id") @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  title     String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact     Contact      @relation(fields: [contactId], references: [id], onDelete: Restrict)
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskDetails TaskDetail[]
  tasks       Task[]

  @@index([companyId], name: "idx_working_orders_company_id")
  @@index([projectId], name: "idx_working_orders_project_id")
  @@map("working_orders")
}

model TaskCategory {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  name      String
  code      String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  taskDetails TaskDetail[]
  tasks       Task[]

  @@unique([companyId, code], name: "task_categories_company_code_unique")
  @@index([companyId], name: "idx_task_categories_company_id")
  @@map("task_categories")
}

model TaskDetail {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId      String   @map("company_id") @db.Uuid
  contactId      String   @map("contact_id") @db.Uuid
  projectId      String   @map("project_id") @db.Uuid
  workingOrderId String   @map("working_order_id") @db.Uuid
  categoryId     String?  @map("category_id") @db.Uuid
  categoryName   String   @map("category_name")
  title          String
  instructions   String[]
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact      Contact       @relation(fields: [contactId], references: [id], onDelete: Restrict)
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  workingOrder WorkingOrder  @relation(fields: [workingOrderId], references: [id], onDelete: Cascade)
  category     TaskCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tasks        Task[]

  @@index([companyId], name: "idx_task_details_company_id")
  @@index([workingOrderId], name: "idx_task_details_working_order_id")
  @@map("task_details")
}

model Task {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId       String    @map("company_id") @db.Uuid
  contactId       String    @map("contact_id") @db.Uuid
  projectId       String    @map("project_id") @db.Uuid
  workingOrderId  String    @map("working_order_id") @db.Uuid
  taskDetailId    String    @map("task_detail_id") @db.Uuid
  categoryId      String?   @map("category_id") @db.Uuid
  categoryName    String    @map("category_name")
  taskDetailTitle String    @map("task_detail_title")
  instructions    String[]
  instructionsCompleted Boolean[] @default([]) @map("instructions_completed")
  scheduleEnabled Boolean   @default(false) @map("schedule_enabled")
  shiftType       String?   @map("shift_type")
  scheduledDate   DateTime? @map("scheduled_date") @db.Date
  startTime       String?   @map("start_time")
  endTime         String?   @map("end_time")
  isRepeating     Boolean   @default(false) @map("is_repeating")
  repeatFrequency String?   @map("repeat_frequency")
  repeatEndDate   DateTime? @map("repeat_end_date") @db.Date
  status          String    @default("open")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  company      Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact      Contact          @relation(fields: [contactId], references: [id], onDelete: Restrict)
  project      Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  workingOrder WorkingOrder     @relation(fields: [workingOrderId], references: [id], onDelete: Cascade)
  taskDetail   TaskDetail       @relation(fields: [taskDetailId], references: [id], onDelete: Cascade)
  category     TaskCategory?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  assignments  TaskAssignment[]

  @@index([companyId], name: "idx_tasks_company_id")
  @@index([projectId], name: "idx_tasks_project_id")
  @@index([workingOrderId], name: "idx_tasks_working_order_id")
  @@index([taskDetailId], name: "idx_tasks_task_detail_id")
  @@index([scheduledDate], name: "idx_tasks_scheduled_date")
  @@index([status], name: "idx_tasks_status")
  @@map("tasks")
}

model TaskAssignment {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  taskId         String   @map("task_id") @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  teamId         String?  @map("team_id") @db.Uuid
  userName       String?  @map("user_name")
  userSurname    String?  @map("user_surname")
  userEmail      String   @map("user_email")
  teamName       String?  @map("team_name")
  teamCode       String?  @map("team_code")
  teamColor      String?  @map("team_color")
  assignmentType String   @map("assignment_type")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  task Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team? @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@unique([taskId, userId], name: "task_assignments_task_user_unique")
  @@index([taskId], name: "idx_task_assignments_task_id")
  @@index([userId], name: "idx_task_assignments_user_id")
  @@map("task_assignments")
}